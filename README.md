# 蒲郡市議会わかりやすビューア

愛知県蒲郡市議会のYouTube動画を自動的に文字起こしし、市民の皆様にわかりやすくお届けするWebサイトです。

## 運用方針: ほぼ管理せず、自動で更新

**人的な運用を極力減らし、自動でわかりやすい記事がどんどん増えていくシステム**を目指します。

| 方針 | 内容 |
|------|------|
| **自動化** | 新着動画の取得 → 文字起こし → 要約 → インフォグラフィック生成まで、Cron で一括実行。管理者は「たまに状態確認」程度でよい設計にする。 |
| **わかりやすい記事** | LLM で市民向けのやさしい要約に統一。議会種類（定例会・臨時会・委員会）や日付・論点を整理して表示。 |
| **管理画面** | 障害時や特別な場合のみ手動で「今すぐ取得」「処理開始」を使う。普段は Cron に任せる。 |

## 議員名の正確性: 市役所HPを参照

議員名を**間違えない・創作しない**ため、**蒲郡市役所の公式HP**を正とするデータを使います。

| 項目 | 内容 |
|------|------|
| **参照元** | 蒲郡市役所の公式サイト（議会・議員名簿など）から、現職議員の氏名リストを取得・保持する。 |
| **取得方法** | 市HPに議員名簿ページがあれば、定期的に取得（スクレイプまたは手動更新）して DB や設定（例: `council_members` テーブル / JSON）に保存。API が公開されていればそれを利用。 |
| **要約時の利用** | LLM で要約するとき、**議員名リストをプロンプトのコンテキストとして渡す**。「このリストにない名前は使わない」「表記はリストに合わせる」と指示し、誤表記・創作を防ぐ。 |
| **更新** | 選挙・欠員等で議員が変わったら、市HPの情報に合わせてリストを更新（Cron で定期取得するか、管理画面で一括更新）。 |

## 用語・名称の正確性: 参照データ（施設・地名・議会種類・議会用語・役職）

議員名に加え、**施設名・地名・議会種類・議会用語・役職**も間違えないように、参照データを用意して要約時に渡します。

| データ | 内容 | ファイル |
|--------|------|----------|
| **施設** | ゆとりーな蒲郡、寿楽荘、蒲郡市民病院、保健医療センター、市民体育センター、市民会館 等（正式名称・読み・表記ゆれ） | `data/gamagori-reference.json` |
| **地名** | 宇連ダム、大塚町、豊岡町、清田町、形原町、三谷町、西浦町 等 | 同上 |
| **議会種類** | 定例会（regular）、臨時会（extraordinary）、委員会（committee）の正式名称と dbValue | 同上 |
| **議会用語** | 議案、補正予算、一般質問、採決、諸般の報告、節水対策、物価高騰 等（説明付き） | 同上 |
| **役職** | 議長、副議長、市長、副市長 等 | 同上 |

要約時は `data/gamagori-reference.json` を読み込み、**議員名リスト（市役所HP）** とあわせて LLM のプロンプトに渡し、「施設名・地名・議会種類・議会用語・役職はこの参照データの表記に合わせる」と指示して誤表記・創作を防ぐ。参照データは必要に応じて市HP等に合わせて更新する。

## 技術スタック（方針）

| 役割 | 採用 |
|------|------|
| フレームワーク | Next.js 14+ (App Router) |
| DB・ストレージ | Supabase (PostgreSQL + Storage) |
| 文字起こし | OpenAI Whisper API |
| 要約 | OpenAI GPT-4o / GPT-4o-mini 等 |
| **画像生成（インフォグラフィック）** | **ナノバナナ Pro (Nano Banana Pro) API** |
| YouTube取得 | YouTube Data API v3 |

画像生成は [ナノバナナ API](https://nanobanana.im/ja/api) の **Nano Banana Pro**（スタジオ品質・8クレジット/枚）を使用します。ベースモデルは **Gemini 3 Pro Image**（`gemini-3-pro-image-preview`、入出力: Image and Text）。

## 機能概要

- **自動処理**: YouTube動画取得 → 文字起こし（Whisper）→ AI要約（LLM）→ インフォグラフィック生成（ナノバナナ）
- **ユーザー向け**: 記事一覧・検索・フィルタ・詳細（要約／全文／インフォグラフィック）
- **自動更新**: 新着動画が公開されたら**自動で**取得・処理し、わかりやすい記事がどんどん増えていく（ほぼ管理不要）
- **管理**: 障害時などにのみ手動で「今すぐ取得」「処理開始」を使用（普段は Cron に任せる）

## デザイン・見やすさ（テーマカラー: オレンジ）

市民に使いやすい「見やすいサイト」を目指します。

| 方針 | 内容 |
|------|------|
| **テーマカラー** | **オレンジ**をメインに。ヘッダー・ボタン・リンク・アクセントに統一し、蒲郡市の温かみ・親しみやすさを表現。 |
| **コントラスト** | 背景と文字のコントラストを十分に取り、高齢者を含む誰でも読みやすいようにする（WCAG を意識）。 |
| **余白・タイポグラフィ** | 行間・段落の余白を広めに。フォントサイズは本文で 16px 前後、見出しの階層をはっきりさせる。 |
| **レスポンシブ** | スマホ〜PC で同じように見やすく。タップしやすいボタンサイズ、横スクロールのないレイアウト。 |

実装時は Tailwind 等でオレンジ系のカラーパレット（例: `orange-500` をメイン、`orange-600` ホバー、`orange-50` 背景）を定義し、全体で統一する。

## 新着動画の自動更新

新しい動画が蒲郡市議会チャンネルに公開されたら、**自動的に取得・処理してサイトを更新**します。

| 項目 | 内容 |
|------|------|
| **取得** | 定期的に YouTube Data API でチャンネルの新着動画を取得。既存 DB にない動画だけ `videos` に追加（`status: pending`）。 |
| **処理** | 未処理（`pending`）の動画を順に「文字起こし → 要約 → インフォグラフィック生成」するジョブを実行。 |
| **実行方法** | **Vercel Cron** または **外部 cron（GitHub Actions / サーバー cron）** で、例えば 1 日 1〜2 回、`/api/cron/fetch-and-process` のような API を叩く。API 内で「新着取得 → 先頭 1 本を処理」などとし、1 回の実行時間制限に合わせて設計。 |
| **管理画面** | 手動での「今すぐ取得」「今すぐ処理」も残し、自動と併用できるようにする。 |

## セキュリティ対策（市民公開を前提）

市民に公開するため、以下の対策を実装方針に含めます。

| 対策 | 内容 |
|------|------|
| **認証・認可** | 管理画面・管理APIは Supabase Auth 等で管理者のみアクセス可能に。一般公開APIは読み取り専用。 |
| **シークレット管理** | APIキー（OpenAI / YouTube / ナノバナナ / Supabase service key）はサーバー側の環境変数のみ。クライアントに露出しない。 |
| **入力検証** | 検索・フィルタ等のユーザー入力を検証・サニタイズ。API はパラメータの型・長さ・許可値でチェック。 |
| **DB アクセス制御** | Supabase の Row Level Security (RLS) で、公開記事のみ読み取り可能。管理用は service role または認証済み管理者のみ。 |
| **HTTPS・ヘッダー** | 本番は必ず HTTPS。Content-Security-Policy、X-Frame-Options、X-Content-Type-Options 等のセキュリティヘッダーを設定。 |
| **レート制限** | 公開API・検索にレート制限をかけ、悪用・負荷集中を防止。 |
| **依存関係** | `npm audit` の定期実行。Dependabot 等で脆弱性対応を継続。 |
| **個人情報** | 文字起こし・要約に個人情報が含まれる場合は公開範囲・匿名化のポリシーを決め、必要に応じてマスキング。 |

## セットアップ

1. **リポジトリのクローン・依存関係**
   - `npm install`
2. **環境変数**
   - `.env.local.example` をコピーして `.env.local` を作成し、各キーを設定。
   - 必須: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
   - YouTube: `YOUTUBE_API_KEY`, `YOUTUBE_CHANNEL_ID`（蒲郡市議会チャンネルID）
   - 要約: `OPENAI_API_KEY`
   - 画像生成: `NANOBANANA_API_KEY`
   - Cron: `CRON_SECRET`（Vercel Cron から `/api/cron/fetch-and-process` を呼ぶ際の認証用）
3. **Supabase**
   - プロジェクト作成後、SQL Editor で `supabase/schema.sql` を実行。
   - Storage でバケット `infographics` を新規作成し、公開（Public）にする。
4. **起動**
   - `npm run dev` でローカル起動。`http://localhost:3000` で記事一覧・管理画面を利用可能。

## 開発メモ

- **文字起こし**: 現状は YouTube 字幕（`youtube-transcript`）を使用。字幕がない動画は文字起こしが空になり、要約・画像はスキップされる。Whisper を使う場合は音声を yt-dlp 等で取得してから OpenAI Whisper API を呼ぶ処理を `lib/whisper.ts` に追加する。
- **ナノバナナ API**: `lib/infographic.ts` のエンドポイント・リクエスト形式は [ナノバナナ API ドキュメント](https://nanobanana.im/ja/api) に合わせて調整する必要がある場合があります。
- **議員名簿**: `council_members` テーブルに市役所HPの議員名を登録すると、要約時に正しい氏名が使われます。管理画面から一括登録する機能は未実装。手動で Supabase に投入するか、Cron で市HPから取得する処理を追加可能。
